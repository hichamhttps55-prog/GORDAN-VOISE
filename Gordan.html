<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> ÕÊÌ· «·‰’ ≈·Ï ﬂ·«„ »«·–ﬂ«¡ «·«’ÿ‰«⁄Ì</title>
    <!--  Õ„Ì· Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!--  Õ„Ì· Œÿ Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+Arabic:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans Arabic', 'Inter', sans-serif;
        }
        /*  ’„Ì„ „Œ’’ ·‘—Ìÿ «· „—Ì— */
        textarea::-webkit-scrollbar {
            width: 8px;
        }
        textarea::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 10px;
        }
        textarea::-webkit-scrollbar-thumb {
            background: #94a3b8;
            border-radius: 10px;
        }
        textarea::-webkit-scrollbar-thumb:hover {
            background: #475569;
        }
        /* √ÌﬁÊ‰… «· Õ„Ì· */
        .loader {
            border: 4px solid #f3f4f6;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">
    <div class="bg-white shadow-2xl rounded-2xl p-6 md:p-8 w-full max-w-2xl">
        <h1 class="text-2xl md:text-3xl font-bold text-center text-gray-800 mb-6">
            ?? „ÕÊ· «·‰’ ≈·Ï ﬂ·«„ »«·–ﬂ«¡ «·«’ÿ‰«⁄Ì
        </h1>
        
        <div class="space-y-5">
            <!-- ’‰œÊﬁ ≈œŒ«· «·‰’ -->
            <div>
                <label for="text-input" class="block text-sm font-medium text-gray-700 mb-2">«·‰’ «·„—«œ  ÕÊÌ·Â:</label>
                <textarea id="text-input" rows="8" class="w-full p-4 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-200 resize-y" placeholder="√œŒ· «·‰’ Â‰«..."></textarea>
            </div>
            
            <!-- Õﬁ·  ÊÃÌÂ«  «·’Ê  -->
            <div>
                <label for="speech-hint" class="block text-sm font-medium text-gray-700 mb-2"> ÊÃÌÂ«  «·’Ê  («Œ Ì«—Ì):</label>
                <input type="text" id="speech-hint" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-200" placeholder="„À«·: ﬁ· »Õ„«”° √Ê »’Ê  Â«œ∆...">
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- «Œ Ì«— «·’Ê  -->
                <div>
                    <label for="voice-select" class="block text-sm font-medium text-gray-700 mb-2">«Œ — «·’Ê :</label>
                    <select id="voice-select" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-200 bg-white"></select>
                </div>
                
                <!-- «Œ Ì«— «··€… -->
                <div>
                    <label for="language-select" class="block text-sm font-medium text-gray-700 mb-2">«··€… («Œ Ì«—Ì):</label>
                    <select id="language-select" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-200 bg-white"></select>
                </div>
            </div>

            <!-- “— «· ÕÊÌ· -->
            <button id="generate-button" class="w-full bg-blue-600 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300 transition duration-300 ease-in-out text-lg">
                 ÕÊÌ· ≈·Ï ’Ê 
            </button>

            <!-- „ƒ‘— «· Õ„Ì· -->
            <div id="loader" class="hidden flex justify-center items-center py-4">
                <div class="loader"></div>
                <p class="mr-3 text-gray-600">Ã«—Ì «·„⁄«·Ã…... ﬁœ Ì” €—ﬁ Â–« »⁄÷ «·Êﬁ .</p>
            </div>

            <!-- —”«·… «·Œÿ√ -->
            <div id="error-message" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg" role="alert">
                <strong class="font-bold">Œÿ√!</strong>
                <span class="block sm:inline" id="error-text"></span>
            </div>

            <!-- „‘€· «·’Ê  -->
            <audio id="audio-player" controls class="w-full mt-4 hidden rounded-lg shadow-inner"></audio>
        </div>
    </div>

    <script type_module>
        // --- ≈⁄œ«œ«  Ê«ÃÂ… »—„Ã… «· ÿ»Ìﬁ«  ---
        const API_KEY = ""; // « —ﬂ Â–« ›«—€«° ”Ì „  Ê›Ì—Â »Ê«”ÿ… «·»Ì∆…
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${API_KEY}`;
        
        // --- ﬁ«∆„… «·√’Ê«  «·„ «Õ… ---
        const VOICES = [
            "Zephyr", "Puck", "Charon", "Kore", "Fenrir", "Leda", "Orus", "Aoede", "Callirrhoe", 
            "Autonoe", "Enceladus", "Iapetus", "Umbriel", "Algieba", "Despina", "Erinome", "Algenib", 
            "Rasalgethi", "Laomedeia", "Achernar", "Alnilam", "Schedar", "Gacrux", "Pulcherrima", 
            "Achird", "Zubenelgenubi", "Vindemiatrix", "Sadachbia", "Sadaltager", "Sulafat"
        ];
        
        // --- ﬁ«∆„… «··€«  (··«Œ Ì«— «·«Œ Ì«—Ì) ---
        const LANGUAGES = {
            "«ﬂ ‘«›  ·ﬁ«∆Ì": "",
            "«·⁄—»Ì… („’—)": "ar-EG",
            "«·≈‰Ã·Ì“Ì… (√„—Ìﬂ«)": "en-US",
            "«·≈‰Ã·Ì“Ì… («·Â‰œ)": "en-IN",
            "«·≈”»«‰Ì… (√„—Ìﬂ«)": "es-US",
            "«·›—‰”Ì… (›—‰”«)": "fr-FR",
            "«·√·„«‰Ì… (√·„«‰Ì«)": "de-DE",
            "«·Â‰œÌ… («·Â‰œ)": "hi-IN",
            "«·≈Ìÿ«·Ì… (≈Ìÿ«·Ì«)": "it-IT",
            "«·Ì«»«‰Ì… («·Ì«»«‰)": "ja-JP",
            "«·ﬂÊ—Ì… (ﬂÊ—Ì«)": "ko-KR",
            "«·»— €«·Ì… («·»—«“Ì·)": "pt-BR",
            "«·—Ê”Ì… (—Ê”Ì«)": "ru-RU",
            "«· —ﬂÌ… ( —ﬂÌ«)": "tr-TR",
            "«·›Ì ‰«„Ì… (›Ì ‰«„)": "vi-VN"
        };

        // --- ⁄‰«’— «·Ê«ÃÂ… ---
        const textInput = document.getElementById('text-input');
        const speechHintInput = document.getElementById('speech-hint');
        const voiceSelect = document.getElementById('voice-select');
        const languageSelect = document.getElementById('language-select');
        const generateButton = document.getElementById('generate-button');
        const loader = document.getElementById('loader');
        const audioPlayer = document.getElementById('audio-player');
        const errorMessage = document.getElementById('error-message');
        const errorText = document.getElementById('error-text');

        // --- ÊŸ«∆› „”«⁄œ… · ÕÊÌ· «·’Ê  ---

        /**
         *  ÕÊÌ· ”·”·… Base64 ≈·Ï ArrayBuffer.
         */
        function base64ToArrayBuffer(base64) {
            const binaryString = window.atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        /**
         *  ÕÊÌ· »Ì«‰«  PCM «·√Ê·Ì… ≈·Ï „·› WAV (Blob).
         * Ê«ÃÂ… »—„Ã… «· ÿ»Ìﬁ«   —Ã⁄ PCM 16-bit, 24000Hz, 1 channel.
         */
        function pcmToWav(pcmData, sampleRate) {
            const numSamples = pcmData.length;
            const numChannels = 1;
            const bitsPerSample = 16;
            const byteRate = sampleRate * numChannels * bitsPerSample / 8;
            const blockAlign = numChannels * bitsPerSample / 8;
            
            const wavDataSize = numSamples * numChannels * bitsPerSample / 8;
            const riffDataSize = wavDataSize + 36; // 36 »«Ì  ·· —ÊÌ”… (header)

            const buffer = new ArrayBuffer(riffDataSize + 8);
            const view = new DataView(buffer);

            function writeString(view, offset, string) {
                for (let i = 0; i < string.length; i++) {
                    view.setUint8(offset + i, string.charCodeAt(i));
                }
            }

            // RIFF chunk descriptor
            writeString(view, 0, 'RIFF');
            view.setUint32(4, riffDataSize, true); // little-endian
            writeString(view, 8, 'WAVE');

            // "fmt " sub-chunk
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true); // Subchunk1Size (16 for PCM)
            view.setUint16(20, 1, true);  // AudioFormat (1 for PCM)
            view.setUint16(22, numChannels, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, byteRate, true);
            view.setUint16(32, blockAlign, true);
            view.setUint16(34, bitsPerSample, true);

            // "data" sub-chunk
            writeString(view, 36, 'data');
            view.setUint32(40, wavDataSize, true);

            // ﬂ «»… »Ì«‰«  PCM (ÂÌ »«·›⁄· Int16Array)
            const pcmView = new Int16Array(buffer, 44, numSamples);
            pcmView.set(pcmData);

            return new Blob([buffer], { type: 'audio/wav' });
        }

        // --- ÊŸÌ›… «” œ⁄«¡ Ê«ÃÂ… »—„Ã… «· ÿ»Ìﬁ«  ---

        /**
         *  ‰›Ì– «” œ⁄«¡ Ê«ÃÂ… »—„Ã… «· ÿ»Ìﬁ«  „⁄ ≈⁄«œ… «·„Õ«Ê·…
         */
        async function fetchWithBackoff(url, options, retries = 3, delay = 1000) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.ok) {
                        return await response.json();
                    }
                    if (response.status === 429 || response.status >= 500) {
                        // ≈⁄«œ… «·„Õ«Ê·… ›Ì Õ«·… Œÿ√ «·Œ«œ„ √Ê  Ã«Ê“ «·Õœ
                        console.warn(`Attempt ${i + 1} failed with status ${response.status}. Retrying in ${delay}ms...`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2; // Exponential backoff
                    } else {
                        // Œÿ√ „‰ Ã«‰» «·⁄„Ì·° ·«  ﬁ„ »≈⁄«œ… «·„Õ«Ê·…
                        const errorData = await response.json();
                        throw new Error(errorData.error?.message || `HTTP error! status: ${response.status}`);
                    }
                } catch (error) {
                    if (i === retries - 1) {
                        // ›‘·  Ã„Ì⁄ «·„Õ«Ê·« 
                        console.error('Fetch failed after retries:', error);
                        throw error;
                    }
                    // ›Ì Õ«·… ›‘· «·‘»ﬂ…° «‰ Ÿ— Ê√⁄œ «·„Õ«Ê·…
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2;
                }
            }
        }
        
        /**
         * «·ÊŸÌ›… «·—∆Ì”Ì… ·≈‰‘«¡ «·ﬂ·«„
         */
        async function generateSpeech() {
            const text = textInput.value.trim();
            const hint = speechHintInput.value.trim();
            const voice = voiceSelect.value;
            // «··€… €Ì— „” Œœ„… „»«‘—… ›Ì Â–« «·ÿ·» ·√‰ «·‰„Ê–Ã Ìﬂ ‘›Â«°
            // ·ﬂ‰‰« ‰Õ ›Ÿ »Â« ›Ì «·Ê«ÃÂ… ··«” Œœ«„ «·„” ﬁ»·Ì «·„Õ „·.
            // const language = languageSelect.value; 

            if (!text) {
                showError("«·—Ã«¡ ≈œŒ«· »⁄÷ «·‰’ √Ê·«.");
                return;
            }

            // ≈⁄œ«œ «·Ê«ÃÂ… ·· Õ„Ì·
            generateButton.disabled = true;
            generateButton.classList.add('opacity-50', 'cursor-not-allowed');
            loader.classList.remove('hidden');
            audioPlayer.classList.add('hidden');
            errorMessage.classList.add('hidden');

            // »‰«¡ «·‰’ «·‰Â«∆Ì „⁄ «· ÊÃÌÂ
            const promptText = hint ? `(${hint}): ${text}` : text;

            const payload = {
                contents: [{
                    parts: [{ text: promptText }]
                }],
                generationConfig: {
                    responseModalities: ["AUDIO"],
                    speechConfig: {
                        voiceConfig: {
                            prebuiltVoiceConfig: { voiceName: voice }
                        }
                    }
                },
                model: "gemini-2.5-flash-preview-tts"
            };

            try {
                const result = await fetchWithBackoff(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const part = result?.candidates?.[0]?.content?.parts?.[0];
                const audioData = part?.inlineData?.data;
                const mimeType = part?.inlineData?.mimeType;

                if (audioData && mimeType && mimeType.startsWith("audio/")) {
                    const sampleRateMatch = mimeType.match(/rate=(\d+)/);
                    const sampleRate = sampleRateMatch ? parseInt(sampleRateMatch[1], 10) : 24000; // «·«› —«÷Ì 24kHz

                    // 1. ›ﬂ  ‘›Ì— Base64
                    const pcmBuffer = base64ToArrayBuffer(audioData);
                    // 2.  ÕÊÌ· ≈·Ï Int16Array (ﬂ„« ÂÊ „ Êﬁ⁄ s16le)
                    const pcm16 = new Int16Array(pcmBuffer);
                    // 3.  ÕÊÌ· PCM ≈·Ï WAV Blob
                    const wavBlob = pcmToWav(pcm16, sampleRate);
                    // 4. ≈‰‘«¡ URL ··‹ Blob
                    const audioUrl = URL.createObjectURL(wavBlob);

                    // 5. ⁄—÷ «·„‘€·
                    audioPlayer.src = audioUrl;
                    audioPlayer.classList.remove('hidden');
                    audioPlayer.play(); //  ‘€Ì· «·’Ê   ·ﬁ«∆Ì«

                } else {
                    console.error('Invalid API response structure:', result);
                    showError("·„ Ì „ «·⁄ÀÊ— ⁄·Ï »Ì«‰«  ’Ê Ì… ›Ì «·«” Ã«»….");
                }

            } catch (error) {
                console.error('Error generating speech:', error);
                showError(`ÕœÀ Œÿ√: ${error.message}`);
            } finally {
                // ≈⁄«œ…  ›⁄Ì· «·Ê«ÃÂ…
                generateButton.disabled = false;
                generateButton.classList.remove('opacity-50', 'cursor-not-allowed');
                loader.classList.add('hidden');
            }
        }
        
        /**
         * ⁄—÷ —”«·… Œÿ√
         */
        function showError(message) {
            errorText.textContent = message;
            errorMessage.classList.remove('hidden');
        }

        /**
         * „·¡ «·ﬁÊ«∆„ «·„‰”œ·… ⁄‰œ  Õ„Ì· «·’›Õ…
         */
        function populateDropdowns() {
            // „·¡ √’Ê« 
            VOICES.forEach(voice => {
                const option = document.createElement('option');
                option.value = voice;
                option.textContent = voice;
                voiceSelect.appendChild(option);
            });
            //  ÕœÌœ ’Ê  «› —«÷Ì
            voiceSelect.value = "Puck"; 

            // „·¡ ·€« 
            for (const [name, code] of Object.entries(LANGUAGES)) {
                const option = document.createElement('option');
                option.value = code;
                option.textContent = name;
                languageSelect.appendChild(option);
            }
        }

        // --- —»ÿ «·√Õœ«À ---
        window.addEventListener('load', populateDropdowns);
        generateButton.addEventListener('click', generateSpeech);
    </script>
</body>
</html>
